<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <script src="./soak_test_1_files/d3.v7.min.js.download"></script>
    <script src="./soak_test_1_files/topojson.v3.min.js.download"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #000;
            background-image: url('https://images3.alphacoders.com/803/thumb-1920-80317.jpg');
            background-size: cover;
            background-attachment: fixed;
            color: #c5c6c7;
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
            color: #fff;
        }

        .header {
            text-align: center;
            background-color: #1f2833;
            color: #66fcf1;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
        }

        .section {
            margin-bottom: 20px;
            text-align: center;
        }

        .section h3 {
            font-size: 24px;
            color: #66fcf1;
            border-bottom: 2px solid #66fcf1;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .section p {
            margin: 10px 0;
            font-size: 16px;
        }

        .dropdown-section {
            text-align: center;
        }

        label {
            font-weight: bold;
            margin: 10px 0 5px;
            color: #66fcf1;
            display: block;
            text-align: left;
        }

        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #45a29e;
            background-color: #1f2833;
            color: #66fcf1;
        }

        svg {
            display: block;
            margin: auto;
            border: 1px solid #45a29e;
            background-color: #0b0c10;
        }

        .y.label, .x.label {
            font-size: 14px;
            fill: #c5c6c7;
        }

        .gridlines line {
            stroke: #45a29e;
        }

        .gridlines .domain {
            stroke: none;
        }

        .axis path,
        .axis line {
            fill: none;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-size: 12px;
            fill: #c5c6c7;
        }

        .legend {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 10px;
            background-color: #1f2833;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .legend-item div {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }

        .legend-item span {
            color: #66fcf1;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div>
        <h3>
        <!-- FILL IN TEST NAME -->
        June 12 Power Budget Test
        </h3>
    </div>
    
    <div>
        <p>
            <b>Description:</b>
            <!-- FILL IN DESCRIPTION -->
            28h test
        </p>

        <p>
            <b>Date:</b>
            <!-- FILL IN DATE -->
            Started June 12 8am
        </p>

        <p>
            <b>Duration:</b>
            <!-- FILL IN DURATION -->
            ~28h
        </p>

        <p>
            <b>Branch Name:</b>
            <!-- FILL IN BRANCH NAME -->
            Main
        </p>

        <p>
            <!-- FILL IN COMMIT HASH -->
            <b>Commit Hash:</b>
            Not yet committed
        </p>
    </div>
    
    <div>
        <label for="flight">Choose Flight Software Data:</label>
        <select name="flight" id="flight" onchange="requestData()">
            <option value="Current Mission Mode">Mission Mode</option>
            <option value="ACS Mode">ACS Mode</option>
            <option value="ACS On/Off">ACS On/Off</option>
            <option value="Battery Voltage (Onboard)">Onboard Battery Voltage (V)</option>
            <option value="IMU On/Off">IMU Powered/Unpowered</option>
            <option value="RockBLOCK Sleeping/Awake">RockBLOCK Sleeping/Awake</option>
            <option value="RockBLOCK Mode">RockBLOCK Mode</option>
        </select>

        <label for="power">Choose Power Data:</label>
        <select name="power" id="power" onchange="requestData()">
            <option value="Current to Satellite (mA)">Current to Satellite</option>
            <option value="Battery Voltage (Onboard)">Onboard Battery Voltage (V)</option>
            <option value="Current to/from Batteries (mA)">Current to/from Batteries</option>
            <option value="Current from Solar Panel (mA)">Current from Solar Panel</option>
            <option value="Battery Voltage (TB)">Testbed Battery Voltage</option>
            <option value="Satellite Voltage">Satellite Voltage</option>
            <option value="Solar Panel Voltage">Solar Panel Voltage</option>
            <option value="Power to/from Batteries (mW)">Power to/from Batteries</option>
            <option value="Power consumed by Satellite (mW)">Power Consumed by Satellite</option>
            <option value="Power from Solar Panel (mW)">Power from Solar Panel</option>
        </select>

        <svg width="800" height="500" id="plottin"></svg>
    </div>
    
    <script>
        const requestData = async function () {
            const margin = { "top": 10, "right": 10, "bottom": 40, "left": 70}; // Increase left margin to 70
    
            // Clear the existing graph
            d3.select("#plottin").selectAll("*").remove();
    
            // Remove legend
            d3.select(".legend").remove();
    
            // FILL IN CSV FILE
            const rawData = await d3.csv("June11Transmit_combined.csv", d3.autoType); // Change this accordingly
    
            const flightField = document.getElementById("flight").value;
    
            // Get the selected value from the dropdown menu
            const powerField = document.getElementById("power").value; 
    
            let data = []
    
            // Filter data
            rawData.forEach(d => {
                if (d["Time"] != null && d[flightField] != null && d[powerField] != null) {
                    if (powerField == "Battery Voltage (Onboard)"){
                        if (d[powerField] > 3.5){ // Ensures that battery voltage is above 3.5
                            data.push(d)
                        }
                    }
                    else {
                        data.push(d);
                    }   
                }
            });
    
            // Select SVG and attributes
            const svg = d3.select("#plottin");
            const height = svg.attr("height");
            const width = svg.attr("width");
            const chartHeight = height - margin.top - margin.bottom;
            const chartWidth = width - margin.left - margin.right;
    
            // Build scales
            const timeExtent = d3.extent(data, d => d["Time"]);
            const powerExtent = d3.extent(data, d => d[powerField]);
            console.log(powerExtent);
            const flightValues = [...new Set(data.map(d => d[flightField]))]
    
            const colorScale = d3.scaleOrdinal().domain(flightValues).range(d3.schemeTableau10);
            
            const timeScale = d3.scaleTime().domain(timeExtent).range([0, chartWidth]);
            const powerScale = d3.scaleLinear().domain(powerExtent).range([chartHeight, 0]);
    
            // Remove existing axes and gridlines
            svg.selectAll(".axis").remove();
            svg.selectAll(".gridlines").remove();
    
            // Draw new axes and gridlines
            const yAxis = d3.axisLeft(powerScale).tickPadding(10); // Increase tick padding
            svg.append("g").attr("class", "axis y-axis").attr("transform", `translate(${margin.left - 10}, ${margin.top})`).call(yAxis);
    
            const yGridlines = d3.axisLeft(powerScale).tickSize(-chartWidth - 10).tickFormat("");
            svg.append("g").attr("class", "gridlines y-gridlines").attr("transform", `translate(${margin.left - 10}, ${margin.top})`).call(yGridlines);
            
            const xAxis = d3.axisBottom(timeScale).tickPadding(10); // Increase tick padding
            svg.append("g").attr("class", "axis x-axis").attr("transform", `translate(${margin.left}, ${chartHeight + margin.top + 10})`).call(xAxis);
    
            const xGridlines = d3.axisBottom(timeScale).tickSize(-chartHeight - 10).tickFormat("");
            svg.append("g").attr("class", "gridlines x-gridlines").attr("transform",`translate(${margin.left}, ${chartHeight + margin.top + 10})`).call(xGridlines);
    
            // Append axis interval labels
            svg.append("text").attr("class", "y label").attr("text-anchor", "end").attr("x", -305).attr("y", 10).attr("transform", "rotate(-90)").text(powerField).style("font-size", "11px");
            svg.append("text").attr("class", "x label").attr("text-anchor", "end").attr("x", width / 2).attr("y", height - 4).text("Time").style("font-size", "11px");
        
            // Add chart element
            const chart = svg.append("g").attr("class", "chart").attr("transform", `translate(${margin.left}, ${margin.top})`);
    
            // Add plotted lines
            const lineGenerator = d3.line()
                .x(function(d) { return timeScale(d["Time"]); })
                .y(function(d) { return powerScale(d[powerField]); })
    
            // Add paths connecting circles
            data.forEach((d, i) => {
                if (i > 0) {
                    const prevX = timeScale(data[i - 1]["Time"]);
                    const prevY = powerScale(data[i - 1][powerField]);
    
                    const currentX = timeScale(d["Time"]);
                    const currentY = powerScale(d[powerField]);
    
                    const pathColor = colorScale(d[flightField]);
    
                    chart.append("path")
                    .attr("d", lineGenerator([
                        { "Time": data[i - 1]["Time"], [powerField]: data[i - 1][powerField] },
                        { "Time": d["Time"], [powerField]: d[powerField] }
                    ]))
                    .attr("fill", "none")
                    .attr("stroke", pathColor)
                    .attr("stroke-width", 1);
                }
            });
    
            // Add circles
            const circles = chart.selectAll(".circle")
                .data(data)
                .join("g")
                .attr("class", "circle");
    
            circles.each(function(d) {
                // Select current <g> tag
                const g = d3.select(this);
    
                const x = timeScale(d["Time"]);
                const y = powerScale(d[powerField]);
    
                g.append("circle").attr("cx", x).attr("cy", y).attr("r", 2).attr("fill", function(d) {
                    return colorScale(d[flightField]);
                });
            });
    
            // Legend
            const legendWidth = 300;
            const legendHeight = 50;
            const legendPadding = 5;
            const legendRectSize = 20;  // reduced size for better look
            const legendTextPadding = 10;
    
            // Select or create an element for the legend (SVG or div)
            const legend = d3.select("body") // Replace "body" with your target container or selector
                .append("div") // Replaced with a div for better styling control
                .attr("class", "legend")
                .style("width", legendWidth + "px"); // Specify the width of your legend
    
            // Append colored rectangles and text for each legend item
            const legendItems = legend.selectAll(".legend-item")
                .data(flightValues)
                .enter()
                .append("div")
                .attr("class", "legend-item")
                .style("display", "flex")
                .style("align-items", "center")
                .style("margin-bottom", "5px");
    
            legendItems.append("div")
                .style("width", legendRectSize + "px")
                .style("height", legendRectSize + "px")
                .style("background-color", function(d) { return colorScale(d); }) // Fill with color from colorScale
                .style("margin-right", "5px");
    
            legendItems.append("span")
                .text(function(d) { return d; }); // Text label for the legend
        }
    
        requestData();
    </script>
    